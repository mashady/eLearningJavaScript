<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Courses</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/courses.css" />
    <style>
      .error-message {
        color: red;
        font-size: 0.875rem;
        margin-top: 5px;
      }

      .error-input {
        border-color: red !important;
      }
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 20px;
        color: #2c3e50;
      }

      .title {
        text-align: center;
        margin: 20px 0;
      }

      .title h1 {
        font-size: 2.5rem;
        color: #2c3e50;
        font-weight: 600;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Search Section */
      .search-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .search-section h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2c3e50;
      }

      .search-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      #search-by,
      #search-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        outline: none;
      }

      #search-btn,
      #openModal {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #3498db;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #search-btn:hover,
      #openModal:hover {
        background-color: #2980b9;
      }

      /* Courses List */
      .courses-list {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .courses-list .title h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #2c3e50;
      }

      #courseList {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .course-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .course-card img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .course-card h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .course-card p {
        margin: 5px 0;
        color: #555;
      }

      .course-card button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .course-card button.edit {
        background-color: #f1c40f;
        color: #fff;
      }

      .course-card button.edit:hover {
        background-color: #f39c12;
      }

      .course-card button.delete {
        background-color: #e74c3c;
        color: #fff;
      }

      .course-card button.delete:hover {
        background-color: #c0392b;
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 700px;
        max-width: 90%;
        position: relative;
      }

      .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }

      .form-step {
        display: none;
      }

      .form-step.active {
        display: block;
      }

      .form-step input,
      .form-step textarea,
      .form-step select {
        width: 97%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        outline: none;
      }

      .form-step button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .form-step button[type="submit"] {
        background-color: #2ecc71;
        color: #fff;
      }

      .form-step button[type="submit"]:hover {
        background-color: #27ae60;
      }

      .form-step button[type="button"] {
        background-color: #3498db;
        color: #fff;
      }

      .form-step button[type="button"]:hover {
        background-color: #2980b9;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .search-controls {
          flex-direction: column;
        }

        #search-by,
        #search-input,
        #search-btn,
        #openModal {
          width: 100%;
        }

        #courseList {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Previous HTML remains unchanged -->
    <div class="title">
      <h1>Courses</h1>
    </div>
    <div class="container">
      <div class="search-section">
        <h2>Search Courses</h2>
        <div class="search-controls">
          <select id="search-by">
            <option value="Title">Search by Course Name</option>
            <option value="Category">Search by Category</option>
          </select>
          <input
            type="text"
            id="search-input"
            placeholder="Enter search term"
          />
          <button type="button" id="search-btn">Search</button>
          <button id="openModal">Add Course</button>
        </div>
      </div>

      <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
          <span id="closeModal" class="close-modal">&times;</span>
          <form id="multiStepForm">
            <div id="step1" class="form-step active">
              <h2>Step 1: General Information</h2>
              <input
                type="text"
                id="title"
                name="title"
                placeholder="Enter course title"
                required
              />
              <input
                type="url"
                id="image"
                name="image"
                placeholder="Put course cover"
                required
              />
              <select id="category" name="category" required>
                <option value="" disabled selected>Select a category</option>
              </select>
              <textarea
                id="description"
                name="description"
                placeholder="Add course description"
                required
              ></textarea>
              <input
                type="number"
                id="price"
                name="price"
                step="0.01"
                placeholder="Enter course price (if free, leave empty)"
              />
              <input
                type="text"
                id="duration"
                name="duration"
                placeholder="Course duration"
                required
              />
              <button type="button" id="nextStep1">Next</button>
            </div>

            <div id="step2" class="form-step">
              <h2>Step 2: Number of Lessons</h2>
              <label for="lessonCount"
                >How many lessons do you want to add?</label
              >
              <input
                type="number"
                id="lessonCount"
                name="lessonCount"
                min="1"
                placeholder="Enter lesson number"
                required
              />
              <div style="display: flex; justify-content: space-between">
                <button type="button" id="prevStep2">Previous</button>
                <button type="button" id="nextStep2">Next</button>
              </div>
            </div>

            <div id="lessonSteps" class="form-step">
              <h2>Step <span id="currentLessonNumber"></span>: Add Lesson</h2>
              <div id="lessonFormContainer">
                <input
                  type="text"
                  id="lessonTitle"
                  name="lessonTitle"
                  placeholder="Enter lesson title"
                  required
                />
                <input
                  type="text"
                  id="lessonDuration"
                  name="lessonDuration"
                  placeholder="Enter lesson duration"
                  required
                />
                <input
                  type="url"
                  id="lessonVideo"
                  name="lessonVideo"
                  placeholder="Enter lesson video URL"
                  required
                />
                <input
                  type="url"
                  id="lessonPdf"
                  name="lessonPdf"
                  placeholder="Enter lesson PDF URL"
                  required
                />
              </div>
              <div style="display: flex; justify-content: space-between">
                <button type="button" id="prevLessonStep">Previous</button>
                <button type="button" id="nextLessonStep">Next</button>
              </div>
            </div>

            <div id="finalStep" class="form-step">
              <h2>Review and Submit</h2>
              <p>
                Please review your course details and lessons before submitting.
              </p>
              <div style="display: flex; justify-content: space-between">
                <button type="button" id="prevFinalStep">Previous</button>
                <button type="submit" id="submitForm">Submit</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="courses-list">
        <div class="title">
          <h2>Available Courses</h2>
        </div>
        <div id="courseList"></div>
      </div>
    </div>
    <script type="module">
      // Previous JavaScript remains unchanged until the validation setup
      document.getElementById("search-input").addEventListener("blur", () => {
        console.log("fethced");
        fetchCourses(document.getElementById("search-input").value.trim());
      });
      import { setupValidation } from "../../utils/validation.js";
      let isEditing = false;
      let currentCourseId = null;
      let lessonCount = 0;
      let currentLesson = 1;
      const lessons = [];

      const openModalButton = document.getElementById("openModal");
      const closeModalButton = document.getElementById("closeModal");
      const modalOverlay = document.getElementById("modalOverlay");
      const multiStepForm = document.getElementById("multiStepForm");

      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const lessonSteps = document.getElementById("lessonSteps");
      const finalStep = document.getElementById("finalStep");

      const nextStep1Button = document.getElementById("nextStep1");
      const prevStep2Button = document.getElementById("prevStep2");
      const nextStep2Button = document.getElementById("nextStep2");
      const prevLessonStepButton = document.getElementById("prevLessonStep");
      const nextLessonStepButton = document.getElementById("nextLessonStep");
      const prevFinalStepButton = document.getElementById("prevFinalStep");

      const lessonCountInput = document.getElementById("lessonCount");
      const currentLessonNumber = document.getElementById(
        "currentLessonNumber"
      );
      const lessonTitleInput = document.getElementById("lessonTitle");
      const lessonDurationInput = document.getElementById("lessonDuration");
      const lessonVideoInput = document.getElementById("lessonVideo");
      const lessonPdfInput = document.getElementById("lessonPdf");

      document.addEventListener("DOMContentLoaded", fetchCourses);
      document.addEventListener("DOMContentLoaded", () => {
        /**
    validateOnBlur(lessonPdfInput, "lessonPdf", {
    required: true,
    validURL: true,
  });
     */
      });

      openModalButton.addEventListener("click", () => {
        modalOverlay.classList.add("active");
        showStep(step1);
      });

      closeModalButton.addEventListener("click", () => {
        modalOverlay.classList.remove("active");
        resetForm();
      });

      nextStep1Button.addEventListener("click", () => showStep(step2));
      prevStep2Button.addEventListener("click", () => showStep(step1));
      nextStep2Button.addEventListener("click", () => {
        lessonCount = parseInt(lessonCountInput.value);
        if (lessonCount > 0) {
          currentLesson = 1;
          updateLessonStep();
          showStep(lessonSteps);
        }
      });
      prevLessonStepButton.addEventListener("click", () => {
        if (currentLesson > 1) {
          currentLesson--;
          updateLessonStep();
        } else {
          showStep(step2);
        }
      });
      nextLessonStepButton.addEventListener("click", () => {
        saveCurrentLesson();
        if (currentLesson < lessonCount) {
          currentLesson++;
          updateLessonStep();
        } else {
          showStep(finalStep);
        }
      });
      prevFinalStepButton.addEventListener("click", () => {
        currentLesson = lessonCount;
        updateLessonStep();
        showStep(lessonSteps);
      });

      function updateLessonStep() {
        currentLessonNumber.textContent = currentLesson;
        const lesson = lessons[currentLesson - 1] || {};
        lessonTitleInput.value = lesson.lessonTitle || "";
        lessonDurationInput.value = lesson.lessonDuration || "";
        lessonVideoInput.value = lesson.lessonVideo || "";
        lessonPdfInput.value = lesson.lessonPdf || "";
      }

      function saveCurrentLesson() {
        const lesson = {
          lessonTitle: lessonTitleInput.value,
          lessonDuration: lessonDurationInput.value,
          lessonVideo: lessonVideoInput.value,
          lessonPdf: lessonPdfInput.value,
        };
        lessons[currentLesson - 1] = lesson;
      }

      multiStepForm.addEventListener("submit", function (event) {
        event.preventDefault();
        //setupValidation(document.getElementById("title"), "isuuuuuue", )
        const title = document.getElementById("title").value;
        const image = document.getElementById("image").value;
        const category = document.getElementById("category").value;
        const description = document.getElementById("description").value;
        const price =
          parseFloat(document.getElementById("price").value) || null;
        const duration = document.getElementById("duration").value;

        const updatedCourse = {
          ID: isEditing ? currentCourseId : Date.now(),
          Title: title,
          Image: image,
          Category: category,
          Description: description,
          Price: price,
          Duration: duration,
          Content: lessons.map((lesson, index) => ({
            lesson_id: index + 1,
            lesson_title: lesson.lessonTitle,
            lesson_duration: lesson.lessonDuration,
            lesson_video: lesson.lessonVideo,
            lesson_pdf: lesson.lessonPdf,
          })),
        };

        if (localStorage.getItem("Courses") == "undefined") {
          console.log(
            "courses exist but undifined so we cannot use json parse "
          );
          console.log(localStorage.getItem("Courses"));
        } else {
          console.log(localStorage.getItem("Courses"));
          var courses = JSON.parse(localStorage.getItem("Courses")) || [];

          console.log("courses not exist");
        }
        if (isEditing) {
          const courseIndex = courses.findIndex(
            (course) => course.ID === Number(currentCourseId)
          );
          if (courseIndex !== -1) {
            courses[courseIndex] = updatedCourse;
          } else {
            alert("Course not found, adding as new");
            courses.push(updatedCourse);
          }
        } else {
          courses.push(updatedCourse);
        }

        localStorage.setItem("Courses", JSON.stringify(courses));
        modalOverlay.classList.remove("active");
        resetForm();
        fetchCourses();
        alert(
          isEditing
            ? "Course updated successfully!"
            : "Course added successfully!"
        );
        isEditing = false;
        currentCourseId = null;
      });

      function resetForm() {
        multiStepForm.reset();
        lessonCount = 0;
        currentLesson = 1;
        lessons.length = 0;
        showStep(step1);
      }

      function showStep(step) {
        document
          .querySelectorAll(".form-step")
          .forEach((s) => s.classList.remove("active"));
        step.classList.add("active");
      }

      function fetchCourses() {
        if (localStorage.getItem("Courses") == "undefined") {
          console.log(
            "courses exist but undifined so we cannot use json parse "
          );
          console.log(localStorage.getItem("Courses"));
        } else {
          console.log(localStorage.getItem("Courses"));
          var courses = JSON.parse(localStorage.getItem("Courses")) || [];

          console.log("courses not exist");
        }

        const courseListContainer = document.getElementById("courseList");

        if (!courseListContainer) {
          console.error("courseList element not found!");
          return;
        }

        courseListContainer.innerHTML = ""; // Clear previous courses

        courses?.forEach((course) => {
          const courseElement = document.createElement("div");
          courseElement.classList.add("course-card");
          courseElement.innerHTML = `
              <img src="${course.Image}" alt="${
            course.Title
          }" class="course-image">
              <h3>${course.Title}</h3>
              <p>${course.Description}</p>
              <p><strong>Category:</strong> ${course.Category}</p>
              <p><strong>Price:</strong> ${course.Price || "Free"}</p>
              <p><strong>Duration:</strong> ${course.Duration}</p>
              <button onclick="editCourse(${course.ID})">Edit</button>
              <button onclick="deleteCourse(${course.ID})">Delete</button>
          `;
          courseListContainer.appendChild(courseElement);
        });
      }

      function editCourse(courseId) {
        let courses = JSON.parse(localStorage.getItem("Courses")) || [];
        if (courses && typeof courses === "string") {
          try {
            const parsedcourses = JSON.parse(courses);
            console.log(parsedcourses);
          } catch (error) {
            console.error("Failed to parse JSON:", error);
          }
        } else {
          console.error("Invalid or undefined JSON courses");
        }
        const course = courses.find((course) => course.ID === courseId);

        if (!course) {
          alert("Course not found!");
          return;
        }

        isEditing = true;
        currentCourseId = course.ID;

        document.getElementById("title").value = course.Title;
        document.getElementById("image").value = course.Image;
        document.getElementById("category").value = course.Category;
        document.getElementById("description").value = course.Description;
        document.getElementById("price").value = course.Price;
        document.getElementById("duration").value = course.Duration;
        lessons.length = 0;
        course.Content.forEach((lesson, index) => {
          lessons[index] = {
            lessonTitle: lesson.lesson_title,
            lessonDuration: lesson.lesson_duration,
            lessonVideo: lesson.lesson_video,
            lessonPdf: lesson.lesson_pdf,
          };
        });

        lessonCountInput.value = course.Content.length;
        lessonCount = course.Content.length;
        currentLesson = 1;
        updateLessonStep();

        modalOverlay.classList.add("active");
        showStep(step1);
      }

      function deleteCourse(courseId) {
        if (confirm("Are you sure you want to delete this course?")) {
          let courses = JSON.parse(localStorage.getItem("Courses")) || [];
          if (courses && typeof courses === "string") {
            try {
              const parsedcourses = JSON.parse(courses);
              console.log(parsedcourses);
            } catch (error) {
              console.error("Failed to parse JSON:", error);
            }
          } else {
            console.error("Invalid or undefined JSON courses");
          }
          courses = courses.filter((course) => course.ID !== courseId);
          localStorage.setItem("Courses", JSON.stringify(courses));
          fetchCourses();
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const categories = JSON.parse(localStorage.getItem("categories")) || [];

        const categoryDropdown = document.getElementById("category");

        categoryDropdown.innerHTML =
          '<option value="" disabled selected>Select a category</option>';

        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.name;
          option.textContent = category.name;
          categoryDropdown.appendChild(option);
        });
      });
      function setupValidation(inputElement, errorMessageId, validationRules) {
        inputElement.addEventListener("blur", () => {
          const value = inputElement.value.trim();
          const errorMessageElement = document.getElementById(errorMessageId);

          if (!errorMessageElement) {
            const errorMessage = document.createElement("div");
            errorMessage.id = errorMessageId;
            errorMessage.className = "error-message";
            inputElement.parentNode.insertBefore(
              errorMessage,
              inputElement.nextSibling
            );
          }

          let isValid = true;
          let errorMessage = "";

          if (validationRules.required && !value) {
            isValid = false;
            errorMessage = "This field is required.";
          }

          if (validationRules.validURL && value && !isValidURL(value)) {
            isValid = false;
            errorMessage = "Please enter a valid URL.";
          }

          if (
            validationRules.minLength &&
            value.length < validationRules.minLength
          ) {
            isValid = false;
            errorMessage = `Minimum length is ${validationRules.minLength} characters.`;
          }

          if (
            validationRules.maxLength &&
            value.length > validationRules.maxLength
          ) {
            isValid = false;
            errorMessage = `Maximum length is ${validationRules.maxLength} characters.`;
          }

          if (!isValid) {
            inputElement.classList.add("error-input");
            errorMessageElement.textContent = errorMessage;
            inputElement.focus();
          } else {
            inputElement.classList.remove("error-input");
            errorMessageElement.textContent = "";
          }
        });
      }

      function isValidURL(url) {
        try {
          new URL(url);
          return true;
        } catch (e) {
          return false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupValidation(document.getElementById("title"), "titleError", {
          required: true,
          minLength: 3,
          maxLength: 100,
        });

        setupValidation(document.getElementById("image"), "imageError", {
          required: true,
          validURL: true,
        });

        setupValidation(document.getElementById("category"), "categoryError", {
          required: true,
        });

        setupValidation(
          document.getElementById("description"),
          "descriptionError",
          {
            required: true,
            minLength: 10,
            maxLength: 500,
          }
        );

        setupValidation(document.getElementById("price"), "priceError", {
          required: false,
        });

        setupValidation(document.getElementById("duration"), "durationError", {
          required: true,
          minLength: 1,
          maxLength: 50,
        });

        setupValidation(
          document.getElementById("lessonTitle"),
          "lessonTitleError",
          {
            required: true,
            minLength: 3,
            maxLength: 100,
          }
        );

        setupValidation(
          document.getElementById("lessonDuration"),
          "lessonDurationError",
          {
            required: true,
            minLength: 1,
            maxLength: 50,
          }
        );

        setupValidation(
          document.getElementById("lessonVideo"),
          "lessonVideoError",
          {
            required: true,
            validURL: true,
          }
        );

        setupValidation(
          document.getElementById("lessonPdf"),
          "lessonPdfError",
          {
            required: true,
            validURL: true,
          }
        );
      });

      // Rest of the JavaScript remains unchanged
    </script>
  </body>
</html>
